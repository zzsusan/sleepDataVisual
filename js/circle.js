var width = 800,
    height = 800,
    start = 0,
    end = 2.25,
    numSpirals = 3
margin = {top:50,bottom:50,left:50,right:50};

var theta = function(r) {
    return numSpirals * Math.PI * r;
};

// used to assign nodes color by group
var color = d3.scaleOrdinal(d3.schemeCategory10);

var r = d3.min([width, height]) / 2 - 40;

var radius = d3.scaleLinear()
    .domain([start, end])
    .range([40, r]);

var svg = d3.select("#chart").append("svg")
    .attr("width", width + margin.right + margin.left)
    .attr("height", height + margin.left + margin.right)
    .append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

var points = d3.range(start, end + 0.001, (end - start) / 1000);

var spiral = d3.radialLine()
    .curve(d3.curveCardinal)
    .angle(theta)
    .radius(radius);

var path = svg.append("path")
    .datum(points)
    .attr("id", "spiral")
    .attr("d", spiral)
    .style("fill", "none")
    .style("stroke", "steelblue");

var spiralLength = path.node().getTotalLength(),
    N = 887,
    barWidth = (spiralLength / N) - 1;

var date = ['2014-12-30','2014-12-31','2015-1-1','2015-1-2','2015-1-3','2015-1-4','2015-1-5','2015-1-6','2015-1-7','2015-1-8','2015-1-9','2015-1-10','2015-1-11','2015-1-12','2015-1-13','2015-1-14','2015-1-15','2015-1-16','2015-1-17','2015-1-18','2015-1-19','2015-1-19','2015-1-20','2015-1-21','2015-1-22','2015-1-26','2015-1-27','2015-1-29','2015-1-30','2015-1-31','2015-2-2','2015-2-3','2015-2-4','2015-2-5','2015-2-9','2015-2-10','2015-2-11','2015-2-12','2015-2-13','2015-2-16','2015-2-17','2015-2-18','2015-2-20','2015-2-21','2015-2-22','2015-2-23','2015-2-25','2015-2-26','2015-2-27','2015-3-2','2015-3-4','2015-3-5','2015-3-6','2015-3-9','2015-3-10','2015-3-11','2015-3-12','2015-3-13','2015-3-16','2015-3-17','2015-3-18','2015-3-21','2015-3-23','2015-3-25','2015-3-26','2015-3-27','2015-3-31','2015-4-1','2015-4-5','2015-4-7','2015-4-8','2015-4-9','2015-4-10','2015-4-11','2015-4-12','2015-4-13','2015-4-14','2015-4-15','2015-4-17','2015-4-18','2015-4-21','2015-4-23','2015-4-24','2015-4-26','2015-4-27','2015-4-28','2015-4-29','2015-5-1','2015-5-2','2015-5-6','2015-5-7','2015-5-8','2015-5-9','2015-5-11','2015-5-12','2015-5-13','2015-5-15','2015-5-18','2015-5-19','2015-5-21','2015-5-22','2015-5-24','2015-5-25','2015-5-26','2015-5-27','2015-5-29','2015-6-1','2015-6-2','2015-6-4','2015-6-5','2015-6-5','2015-6-8','2015-6-9','2015-6-10','2015-6-11','2015-6-12','2015-6-15','2015-6-16','2015-6-17','2015-6-18','2015-6-19','2015-6-23','2015-6-24','2015-6-25','2015-7-12','2015-7-20','2015-7-21','2015-7-22','2015-7-24','2015-7-27','2015-7-29','2015-7-30','2015-7-31','2015-8-1','2015-8-2','2015-8-3','2015-8-4','2015-8-5','2015-8-6','2015-8-8','2015-8-10','2015-8-11','2015-8-16','2015-8-17','2015-8-18','2015-8-19','2015-8-20','2015-8-21','2015-8-22','2015-8-23','2015-8-24','2015-8-26','2015-8-27','2015-8-28','2015-8-29','2015-8-31','2015-9-1','2015-9-2','2015-9-3','2015-9-6','2015-9-8','2015-9-9','2015-9-10','2015-9-11','2015-9-12','2015-9-14','2015-9-15','2015-9-16','2015-9-17','2015-9-18','2015-9-19','2015-9-20','2015-9-21','2015-9-23','2015-9-24','2015-9-25','2015-9-28','2015-9-29','2015-9-30','2015-10-1','2015-10-3','2015-10-11','2015-10-13','2015-10-14','2015-10-15','2015-10-16','2015-10-17','2015-10-19','2015-10-21','2015-10-22','2015-10-23','2015-10-24','2015-10-25','2015-10-27','2015-10-28','2015-10-29','2015-10-30','2015-10-31','2015-11-3','2015-11-4','2015-11-5','2015-11-6','2015-11-7','2015-11-9','2015-11-10','2015-11-11','2015-11-12','2015-11-14','2015-11-16','2015-11-19','2015-11-20','2015-11-23','2015-11-24','2015-11-25','2015-11-26','2015-11-27','2015-11-28','2015-11-30','2015-12-1','2015-12-2','2015-12-3','2015-12-4','2015-12-7','2015-12-8','2015-12-9','2015-12-10','2015-12-13','2015-12-14','2015-12-16','2015-12-17','2015-12-18','2015-12-21','2015-12-22','2015-12-23','2015-12-24','2015-12-30','2016-1-2','2016-1-3','2016-1-4','2016-1-5','2016-1-6','2016-1-14','2016-1-15','2016-1-18','2016-1-19','2016-1-20','2016-1-21','2016-1-22','2016-1-23','2016-1-25','2016-1-26','2016-1-27','2016-1-28','2016-1-29','2016-1-30','2016-2-1','2016-2-2','2016-2-3','2016-2-4','2016-2-5','2016-2-6','2016-2-7','2016-2-8','2016-2-9','2016-2-10','2016-2-14','2016-2-15','2016-2-16','2016-2-17','2016-2-18','2016-2-19','2016-2-21','2016-2-23','2016-2-24','2016-2-25','2016-2-26','2016-2-28','2016-2-29','2016-3-1','2016-3-2','2016-3-3','2016-3-4','2016-3-6','2016-3-7','2016-3-8','2016-3-9','2016-3-10','2016-3-11','2016-3-12','2016-3-13','2016-3-14','2016-3-15','2016-3-16','2016-3-17','2016-3-18','2016-3-19','2016-3-21','2016-3-22','2016-3-23','2016-3-24','2016-3-28','2016-3-29','2016-3-30','2016-3-31','2016-4-1','2016-4-3','2016-4-4','2016-4-5','2016-4-6','2016-4-7','2016-4-8','2016-4-9','2016-4-10','2016-4-11','2016-4-12','2016-4-13','2016-4-14','2016-4-15','2016-4-16','2016-4-18','2016-4-20','2016-4-21','2016-4-22','2016-4-23','2016-4-25','2016-4-26','2016-4-27','2016-4-28','2016-4-29','2016-4-30','2016-5-2','2016-5-3','2016-5-4','2016-5-5','2016-5-6','2016-5-7','2016-5-8','2016-5-9','2016-5-10','2016-5-11','2016-5-12','2016-5-13','2016-5-14','2016-5-16','2016-5-17','2016-5-18','2016-5-19','2016-5-20','2016-5-21','2016-5-24','2016-5-25','2016-5-26','2016-5-27','2016-5-28','2016-5-30','2016-5-31','2016-6-1','2016-6-2','2016-6-3','2016-6-6','2016-6-7','2016-6-8','2016-6-9','2016-6-10','2016-6-12','2016-6-13','2016-6-14','2016-6-15','2016-6-16','2016-6-17','2016-6-18','2016-6-20','2016-6-21','2016-6-22','2016-6-23','2016-6-24','2016-6-27','2016-6-28','2016-6-29','2016-6-30','2016-7-2','2016-7-4','2016-7-5','2016-7-6','2016-7-7','2016-7-8','2016-7-11','2016-7-12','2016-7-13','2016-7-14','2016-7-15','2016-7-16','2016-7-17','2016-7-18','2016-7-19','2016-7-20','2016-7-21','2016-7-22','2016-7-23','2016-7-24','2016-7-25','2016-7-26','2016-7-27','2016-7-28','2016-7-29','2016-8-17','2016-8-18','2016-8-19','2016-8-21','2016-8-22','2016-8-23','2016-8-24','2016-8-25','2016-8-26','2016-8-27','2016-8-28','2016-8-29','2016-8-30','2016-8-31','2016-9-1','2016-9-2','2016-9-3','2016-9-5','2016-9-6','2016-9-7','2016-9-8','2016-9-9','2016-9-10','2016-9-11','2016-9-12','2016-9-13','2016-9-14','2016-9-15','2016-9-18','2016-9-19','2016-9-20','2016-9-21','2016-9-22','2016-9-23','2016-9-26','2016-9-27','2016-9-28','2016-9-29','2016-9-30','2016-10-1','2016-10-2','2016-10-3','2016-10-4','2016-10-5','2016-10-6','2016-10-7','2016-10-8','2016-10-11','2016-10-12','2016-10-13','2016-10-14','2016-10-16','2016-10-17','2016-10-18','2016-10-19','2016-10-20','2016-10-21','2016-10-22','2016-10-23','2016-10-24','2016-10-25','2016-10-26','2016-10-27','2016-10-28','2016-10-29','2016-10-31','2016-11-2','2016-11-3','2016-11-4','2016-11-5','2016-11-7','2016-11-8','2016-11-9','2016-11-10','2016-11-11','2016-11-12','2016-11-16','2016-11-17','2016-11-18','2016-11-19','2016-11-20','2016-11-21','2016-11-22','2016-11-23','2016-11-24','2016-11-25','2016-11-26','2016-11-28','2016-11-29','2016-11-30','2016-12-1','2016-12-1','2016-12-2','2016-12-4','2016-12-5','2016-12-6','2016-12-7','2016-12-8','2016-12-9','2016-12-10','2016-12-11','2016-12-12','2016-12-13','2016-12-14','2016-12-15','2016-12-16','2016-12-19','2016-12-20','2016-12-21','2016-12-22','2016-12-23','2016-12-28','2016-12-31','2017-1-3','2017-1-3','2017-1-4','2017-1-5','2017-1-6','2017-1-7','2017-1-8','2017-1-9','2017-1-10','2017-1-11','2017-1-12','2017-1-13','2017-1-14','2017-1-16','2017-1-17','2017-1-17','2017-1-18','2017-1-19','2017-1-20','2017-1-21','2017-1-22','2017-1-23','2017-1-24','2017-1-25','2017-1-26','2017-1-27','2017-1-27','2017-1-28','2017-1-31','2017-2-1','2017-2-2','2017-2-3','2017-2-4','2017-2-5','2017-2-6','2017-2-7','2017-2-8','2017-2-9','2017-2-10','2017-2-10','2017-2-11','2017-2-13','2017-2-14','2017-2-14','2017-2-15','2017-2-16','2017-2-17','2017-2-18','2017-2-19','2017-2-20','2017-2-21','2017-2-22','2017-2-23','2017-2-24','2017-2-25','2017-2-26','2017-2-28','2017-3-1','2017-3-2','2017-3-3','2017-3-5','2017-3-6','2017-3-7','2017-3-8','2017-3-9','2017-3-10','2017-3-11','2017-3-13','2017-3-14','2017-3-15','2017-3-16','2017-3-17','2017-3-18','2017-3-19','2017-3-20','2017-3-21','2017-3-22','2017-3-23','2017-3-24','2017-3-26','2017-3-27','2017-3-28','2017-3-29','2017-3-30','2017-3-31','2017-4-1','2017-4-2','2017-4-3','2017-4-4','2017-4-5','2017-4-6','2017-4-7','2017-4-8','2017-4-10','2017-4-11','2017-4-12','2017-4-13','2017-4-14','2017-4-15','2017-4-16','2017-4-17','2017-4-18','2017-4-19','2017-4-20','2017-4-21','2017-4-22','2017-4-23','2017-4-24','2017-4-25','2017-4-26','2017-4-27','2017-4-28','2017-4-29','2017-4-30','2017-5-1','2017-5-2','2017-5-3','2017-5-4','2017-5-5','2017-5-6','2017-5-8','2017-5-9','2017-5-10','2017-5-10','2017-5-11','2017-5-12','2017-5-13','2017-5-14','2017-5-15','2017-5-16','2017-5-17','2017-5-18','2017-5-19','2017-5-20','2017-5-23','2017-5-24','2017-5-25','2017-5-26','2017-5-28','2017-5-29','2017-5-30','2017-5-31','2017-6-1','2017-6-2','2017-6-3','2017-6-4','2017-6-5','2017-6-6','2017-6-7','2017-6-8','2017-6-9','2017-6-10','2017-6-12','2017-6-13','2017-6-14','2017-6-15','2017-6-16','2017-6-18','2017-6-19','2017-6-20','2017-6-21','2017-6-22','2017-6-23','2017-6-24','2017-6-26','2017-6-27','2017-6-28','2017-6-29','2017-6-30','2017-7-3','2017-7-4','2017-7-5','2017-7-6','2017-7-7','2017-7-10','2017-7-11','2017-7-12','2017-7-13','2017-7-14','2017-7-15','2017-7-16','2017-7-17','2017-7-18','2017-7-19','2017-7-20','2017-7-22','2017-7-23','2017-7-24','2017-7-26','2017-7-27','2017-7-28','2017-7-29','2017-7-30','2017-7-31','2017-8-1','2017-8-2','2017-8-3','2017-8-4','2017-8-5','2017-8-6','2017-8-7','2017-8-8','2017-8-9','2017-8-10','2017-8-13','2017-8-14','2017-8-15','2017-8-16','2017-8-17','2017-8-18','2017-8-26','2017-8-28','2017-8-29','2017-8-31','2017-9-1','2017-9-2','2017-9-3','2017-9-4','2017-9-5','2017-9-6','2017-9-7','2017-9-8','2017-9-10','2017-9-12','2017-9-13','2017-9-14','2017-9-15','2017-9-16','2017-9-18','2017-9-19','2017-9-20','2017-9-21','2017-9-22','2017-9-25','2017-9-26','2017-9-27','2017-9-28','2017-9-29','2017-9-30','2017-10-1','2017-10-2','2017-10-3','2017-10-4','2017-10-5','2017-10-6','2017-10-7','2017-10-8','2017-10-10','2017-10-11','2017-10-12','2017-10-13','2017-10-14','2017-10-15','2017-10-16','2017-10-17','2017-10-18','2017-10-19','2017-10-20','2017-10-21','2017-10-22','2017-10-23','2017-10-24','2017-10-25','2017-10-26','2017-10-27','2017-10-29','2017-10-30','2017-10-31','2017-11-1','2017-11-3','2017-11-4','2017-11-6','2017-11-7','2017-11-8','2017-11-9','2017-11-10','2017-11-11','2017-11-12','2017-11-13','2017-11-15','2017-11-16','2017-11-17','2017-11-18','2017-11-20','2017-11-21','2017-11-22','2017-11-23','2017-11-24','2017-11-26','2017-11-27','2017-11-28','2017-11-29','2017-11-30','2017-12-1','2017-12-4','2017-12-5','2017-12-6','2017-12-7','2017-12-8','2017-12-10','2017-12-11','2017-12-12','2017-12-13','2017-12-15','2017-12-18','2017-12-19','2017-12-20','2017-12-21','2017-12-22','2017-12-27','2017-12-29','2017-12-30','2018-1-2','2018-1-3','2018-1-5','2018-1-7','2018-1-8','2018-1-9','2018-1-10','2018-1-11','2018-1-12','2018-1-13','2018-1-14','2018-1-15','2018-1-16','2018-1-17','2018-1-18','2018-1-19','2018-1-20','2018-1-21','2018-1-22','2018-1-23','2018-1-24','2018-1-25','2018-1-26','2018-1-27','2018-1-28','2018-1-29','2018-1-30','2018-1-31','2018-2-1','2018-2-2','2018-2-3','2018-2-4','2018-2-5','2018-2-6','2018-2-7','2018-2-8','2018-2-9','2018-2-10','2018-2-12','2018-2-13','2018-2-14','2018-2-15','2018-2-16','2018-2-17']
var data = [512,510,452,404,432,434,438,447,455,559,436,541,530,488,551,486,433,442,411,471,432,73,480,482,462,559,455,457,425,483,433,469,452,427,497,497,480,456,409,424,373,405,460,420,535,482,469,354,474,569,463,559,470,445,530,481,460,456,420,452,483,409,502,487,442,483,417,452,497,533,541,412,447,470,456,456,445,421,419,452,460,459,446,540,427,441,438,412,466,474,454,454,303,408,423,407,448,646,461,422,398,453,467,443,416,469,423,479,420,325,115,459,439,474,544,445,454,468,479,451,380,433,408,463,571,511,423,462,494,470,487,394,480,409,546,419,434,458,439,457,302,538,466,420,434,492,492,443,487,469,450,468,510,506,479,480,466,479,453,484,447,481,449,406,455,467,476,460,500,442,383,527,488,521,449,442,482,482,445,376,437,511,481,400,460,488,411,507,522,459,464,460,475,415,481,471,460,408,489,443,431,472,474,412,461,452,443,526,493,443,410,453,404,477,414,475,385,479,535,437,411,369,440,460,448,493,494,482,457,440,517,480,443,481,447,496,513,504,471,448,481,455,437,449,458,468,555,530,597,503,490,449,440,435,499,440,445,453,446,515,470,520,421,476,453,330,465,438,432,531,459,508,499,486,464,380,497,445,506,388,486,496,491,431,452,524,429,478,377,427,413,449,463,519,502,570,553,534,536,433,481,416,433,446,462,587,519,545,551,415,480,390,540,432,439,453,465,521,527,532,539,489,460,427,463,451,452,481,473,429,527,509,481,493,474,480,471,396,450,380,461,419,525,513,520,556,434,390,499,415,455,489,491,416,516,480,448,406,399,438,365,419,500,507,598,459,502,478,338,474,474,419,435,449,461,480,494,418,445,443,480,492,491,436,482,492,479,530,493,422,455,467,490,457,428,434,450,472,575,489,448,487,427,501,310,464,453,504,628,491,489,450,499,493,457,513,468,489,479,467,410,549,512,560,490,470,461,381,437,434,454,492,473,596,475,487,456,479,509,451,483,464,429,449,500,506,416,458,508,468,393,482,469,465,436,484,510,447,454,455,455,499,339,520,481,441,466,450,452,454,443,457,458,361,548,469,455,416,437,440,471,560,476,464,456,485,481,421,493,445,519,510,496,470,417,481,84,451,482,480,475,452,452,435,563,439,481,458,482,500,451,431,526,440,453,480,485,540,394,79,489,449,482,569,442,496,477,474,427,437,474,452,432,128,397,489,495,518,509,502,455,437,495,405,102,482,394,456,449,491,429,455,456,470,415,400,388,96,510,556,430,93,415,468,478,500,468,484,463,431,451,439,426,427,454,481,487,475,496,487,501,481,545,433,494,473,462,497,464,484,547,534,438,461,421,432,441,476,449,502,431,454,531,387,594,499,483,489,395,427,449,340,439,436,551,492,607,462,464,461,456,471,446,549,464,479,447,480,486,471,517,463,467,496,496,441,452,440,498,463,389,100,452,527,419,486,502,454,456,476,430,472,546,452,508,484,463,461,462,501,439,461,485,556,426,467,494,460,510,467,472,512,474,458,468,153,459,446,463,457,420,464,490,531,521,508,480,432,461,468,475,477,442,455,506,433,494,403,340,497,446,519,489,408,477,471,463,455,477,413,529,432,459,414,453,438,511,480,548,506,451,390,462,424,438,514,447,496,420,524,557,457,495,544,441,494,437,450,479,459,528,447,484,408,479,513,461,464,467,482,464,493,481,407,482,424,526,453,501,425,524,440,433,527,607,462,456,458,494,551,505,429,489,501,360,540,471,440,490,462,471,485,301,540,454,411,333,536,482,455,469,523,438,551,471,491,530,574,567,454,491,484,453,451,446,453,545,475,442,434,472,541,425,509,439,473,507,515,469,489,465,424,513,506,500,502,524,635,470,608,505,437,545,526,481,411,481,458,426,588,542,468,435,471,447,482,601,437,476,404,498,543,403,547,447,449,503,464,452,560,323,548,412,478,508,449,438,498,504,548,431,536,553,535]

var someData = [];


for (var i = 0; i < N; i++) {
    var currentDate = new Date('2014-12-29');
    currentDate.setDate(currentDate.getDate() + i);
    someData.push({
        date: currentDate,
        value: data[i],
        group: currentDate.getMonth()
    });
}

var timeScale = d3.scaleTime()
    .domain(d3.extent(someData, function(d){
        return d.date;
    }))
    .range([0, spiralLength]);

// yScale for the bar height
var yScale = d3.scaleLinear()
    .domain([0, d3.max(someData, function(d){
        return d.value;
    })])
    .range([0, (r / numSpirals) - 30]);

svg.selectAll("rect")
    .data(someData)
    .enter()
    .append("rect")
    .attr("x", function(d,i){

        var linePer = timeScale(d.date),
            posOnLine = path.node().getPointAtLength(linePer),
            angleOnLine = path.node().getPointAtLength(linePer - barWidth);

        d.linePer = linePer; // % distance are on the spiral
        d.x = posOnLine.x; // x postion on the spiral
        d.y = posOnLine.y; // y position on the spiral

        d.a = (Math.atan2(angleOnLine.y, angleOnLine.x) * 180 / Math.PI) - 90; //angle at the spiral position

        return d.x;
    })
    .attr("y", function(d){
        return d.y;
    })
    .attr("width", function(d){
        return barWidth;
    })
    .attr("height", function(d){
        return yScale(d.value);
    })
    .style("fill", function(d){return color(d.group);})
    .style("stroke", "none")
    .attr("transform", function(d){
        return "rotate(" + d.a + "," + d.x  + "," + d.y + ")"; // rotate the bar
    });

// add date labels
var tF = d3.timeFormat("%b %Y"),
    firstInMonth = {};

svg.selectAll("text")
    .data(someData)
    .enter()
    .append("text")
    .attr("dy", 10)
    .style("text-anchor", "start")
    .style("font", "10px arial")
    .append("textPath")
    // only add for the first of each month
    .filter(function(d){
        var sd = tF(d.date);
        if (!firstInMonth[sd]){
            firstInMonth[sd] = 1;
            return true;
        }
        return false;
    })
    .text(function(d){
        return tF(d.date);
    })
    // place text along spiral
    .attr("xlink:href", "#spiral")
    .style("fill", "grey")
    .attr("startOffset", function(d){
        return ((d.linePer / spiralLength) * 100) + "%";
    })


var tooltip = d3.select("#chart")
    .append('div')
    .attr('class', 'tooltip');

tooltip.append('div')
    .attr('class', 'date');
tooltip.append('div')
    .attr('class', 'value');

svg.selectAll("rect")
    .on('mouseover', function(d) {

        tooltip.select('.date').html("Date: <b>" + d.date.toDateString() + "</b>");
        tooltip.select('.value').html("Value: <b>" + Math.round(d.value*100)/100 + "<b>");

        d3.select(this)
            .style("fill","#FFFFFF")
            .style("stroke","#000000")
            .style("stroke-width","2px");

        tooltip.style('display', 'block');
        tooltip.style('opacity',2);

    })
    .on('mousemove', function(d) {
        tooltip.style('top', (d3.event.layerY + 10) + 'px')
            .style('left', (d3.event.layerX - 25) + 'px');
    })
    .on('mouseout', function(d) {
        d3.selectAll("rect")
            .style("fill", function(d){return color(d.group);})
            .style("stroke", "none")

        tooltip.style('display', 'none');
        tooltip.style('opacity',0);
    });